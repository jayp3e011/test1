<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<title>iMock</title>
		<meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
		<link rel="icon" type="image/png" href="favicon16.png" />
		<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
	</head>
	<body>
		<div class="wrapper">
			<div class="col-xs-3"></div>
			<div class="col-xs-6">
				<div class="form-group">
				<input type="file" class="form-control" id="import">
			</div>
			<label for="count" id="count">0</label>&nbsp;<label for="count" id="saved">0</label>
			<button class="btn btn-lg btn-success" id="btnImport" disabled="disable">Import</button>
			<table class="table table-condense table-responsive" id="excelData">
				<thead>
					<tr>
						<th>No.</th>
						<th>Question</th>
						<th>Answer</th>
						<th>Choice A</th>
						<th>Choice B</th>
						<th>Choice C</th>
						<th>Choice D</th>
						<th>Reference</th>
						<th>Status</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
			
			</div>
			<div class="col-xs-3"></div>
			
		</div>
		<script src="plugins/jQuery/jquery-2.2.3.min.js"></script>  
		<script src="dist/js/xlsx.full.min.js"></script>
		<script>
			$elm = $('#import');
			$elm.on('change', function (changeEvent) {
		        var reader = new FileReader();
		        
		        reader.onload = function (evt) {
					var data = evt.target.result;

					var workbook = XLSX.read(data, {type: 'binary'});

					var headerNames = XLSX.utils.sheet_to_json( workbook.Sheets[workbook.SheetNames[0]], { header: 1 })[0];

					var data = XLSX.utils.sheet_to_json( workbook.Sheets[workbook.SheetNames[0]]);

					// console.log('RAW______'+XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames]));
					// console.log('head____'+headerNames);
					// console.log(data);

					// dt = JSON.parse(data);
					
					data.map(function(xlobject){
						// console.log(rowCount);
						var html = "";
						html+=  "<tr><td>"+xlobject.__rowNum__+"</td>";
						html+=  "<td>"+xlobject.question+"</td>";
						html+=  "<td>"+xlobject.answer+"</td>";
						html+=  "<td>"+xlobject.choice_a+"</td>";
						html+=  "<td>"+xlobject.choice_b+"</td>";
						html+=  "<td>"+xlobject.choice_c+"</td>";
						html+=  "<td>"+xlobject.choice_d+"</td>";
						html+=  "<td>"+xlobject.reference+"</td>";
						html+=  '<td><span class="label label-danger">Not Saved</span></td><tr>';
						$('#excelData tbody').append(html);
						$('#count').text('Rows: '+xlobject.__rowNum__);
						if ($('#btnImport').on('click', function(e){
							e.preventDefault();
							if (saveData(xlobject.question,xlobject.answer,xlobject.choice_a,xlobject.choice_b,xlobject.choice_c,xlobject.choice_d,xlobject.reference)) {
								alert('Saved....');
							}
							
						}));
					});
					setTimeout(changeTableStatus('<span class="label label-warning">Already Saved</span>'),10000);
					$('#btnImport').removeAttr('disabled', 'disable');
		        };
		        
		        reader.readAsBinaryString(changeEvent.target.files[0]);
	      });
		function saveData(question,answer,choice_a,choice_b,choice_c,choice_d,reference)
		{
			var success = false;
			$.ajax({
				method :"POST",
				url : "../app/models/question.php",
				data : {
					'action':'importquestion',
					'question' : question,
					'answer' : answer,
					'choice_a' : choice_a,
					'choice_b' : choice_b,
					'choice_c' : choice_c,
					'choice_d' : choice_d,
					'reference' : reference
				}
				}).done(function(res){
					// alert(res);
					// console.log(res); 
					setTimeout(changeTableStatus('<span class="label label-success">Saved</span>'),3000);
					success = true;
					

				});
				return success;
		}
		function changeTableStatus(status)
		{
			var count = 0;
			$.ajax({
				method :"POST",
				url : "../app/models/question.php"
			}).done(function(dt){
				var dbe = JSON.parse(dt);
				// console.log(dt);
				dbe.map(function(dbobject){
					$('#excelData tbody tr').each(function(row, tr){
				        if ($(tr).find('td:eq(1)').text() === dbobject.question && $(tr).find('td:eq(2)').text()===dbobject.answer && $(tr).find('td:eq(3)').text()===dbobject.choice_a && $(tr).find('td:eq(4)').text()===dbobject.choice_b && $(tr).find('td:eq(5)').text()===dbobject.choice_c && $(tr).find('td:eq(6)').text()===dbobject.choice_d && $(tr).find('td:eq(7)').text()===dbobject.reference) 
				        {
				        	$(tr).find('td:eq(8)').html(status);
				        	$('#btnImport').attr('disabled','disable');
				        	count++;
				        }
				        
				    }); 
				});
				 $('#saved').text(' / Rows saved: '+count);

			});
		}
		</script>
	</body>
</html>